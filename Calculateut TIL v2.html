<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculateur d'Intérêts de Retard V3 - France</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .lucide { 
            width: 1em; 
            height: 1em; 
            stroke: currentColor; 
            fill: none; 
            stroke-width: 2; 
            stroke-linecap: round; 
            stroke-linejoin: round;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Icônes
        const Calculator = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <rect width="16" height="20" x="4" y="2" rx="2"/>
                <line x1="8" x2="16" y1="6" y2="6"/>
            </svg>
        );

        const Calendar = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M8 2v4"/>
                <path d="M16 2v4"/>
                <rect width="18" height="18" x="3" y="4" rx="2"/>
                <path d="M3 10h18"/>
            </svg>
        );

        const Plus = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M5 12h14"/>
                <path d="M12 5v14"/>
            </svg>
        );

        const Trash2 = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M3 6h18"/>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                <line x1="10" x2="10" y1="11" y2="17"/>
                <line x1="14" x2="14" y1="11" y2="17"/>
            </svg>
        );

        const Euro = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M4 10h12"/>
                <path d="M4 14h9"/>
                <path d="M19 6a7.7 7.7 0 0 0-5.2-2A7.9 7.9 0 0 0 6 12a7.9 7.9 0 0 0 7.8 8 7.7 7.7 0 0 0 5.2-2"/>
            </svg>
        );

        const Info = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <path d="M12 16v-4"/>
                <path d="M12 8h.01"/>
            </svg>
        );

        const Upload = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" x2="12" y1="3" y2="15"/>
            </svg>
        );

        const Table = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M12 3v18"/>
                <rect width="18" height="18" x="3" y="3" rx="2"/>
                <path d="M3 9h18"/>
                <path d="M3 15h18"/>
            </svg>
        );

        const CheckCircle = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
        );

        const AlertCircle = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" x2="12" y1="8" y2="12"/>
                <line x1="12" x2="12.01" y1="16" y2="16"/>
            </svg>
        );

        const Download = () => (
            <svg className="lucide" viewBox="0 0 24 24">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" x2="12" y1="15" y2="3"/>
            </svg>
        );

        // Fonction de parsing des données Excel
        const parseExcelData = (text) => {
            const lines = text.split('\n').filter(line => line.trim());
            const debts = [];
            const errors = [];

            // Fonction pour nettoyer et parser un montant
            const parseAmount = (str) => {
                if (!str) return null;
                // Enlever tous les espaces (y compris insécables), €, et remplacer virgule par point
                const cleaned = str.toString()
                    .replace(/\s+/g, '')  // Tous types d'espaces
                    .replace(/€/g, '')
                    .replace(/,/g, '.')
                    .trim();
                
                // Vérifier que c'est un nombre valide
                if (!/^\d+(\.\d+)?$/.test(cleaned)) return null;
                
                const num = parseFloat(cleaned);
                return (isNaN(num) || num <= 0) ? null : num;
            };

            // Fonction pour parser une date (plusieurs formats)
            const parseDate = (str) => {
                if (!str) return null;
                
                str = str.trim();
                
                // Format ISO (YYYY-MM-DD)
                if (/^\d{4}-\d{2}-\d{2}$/.test(str)) {
                    return str;
                }
                
                // Format français (DD/MM/YYYY) - prioritaire
                const frMatch = str.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{4})$/);
                if (frMatch) {
                    const [, day, month, year] = frMatch;
                    const dayNum = parseInt(day);
                    const monthNum = parseInt(month);
                    
                    // Validation: jour entre 1-31, mois entre 1-12
                    if (dayNum >= 1 && dayNum <= 31 && monthNum >= 1 && monthNum <= 12) {
                        return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
                    }
                }
                
                return null;
            };

            // Analyser chaque ligne
            lines.forEach((line, index) => {
                // Ignorer les lignes vides
                if (!line.trim()) return;
                
                // Ignorer les en-têtes probables
                const lowerLine = line.toLowerCase();
                if (lowerLine.includes('montant') || lowerLine.includes('date') || 
                    lowerLine.includes('exigib') || lowerLine.includes('référence') ||
                    lowerLine.includes('facture') && lowerLine.includes('échéance')) {
                    return;
                }

                // Séparer par tabulation, point-virgule, ou plusieurs espaces
                let cells = line.split(/[\t;]|  +/);
                
                // Nettoyer les cellules vides
                cells = cells.filter(cell => cell && cell.trim());
                
                if (cells.length === 0) {
                    return;
                }

                // Essayer de trouver montant et date
                let amount = null;
                let date = null;
                let reference = '';
                let amountCell = '';
                let dateCell = '';

                // Première passe: identifier date et montant
                for (let cell of cells) {
                    const trimmedCell = cell.trim();
                    
                    // Chercher une date (contient un pattern de date)
                    if (!date && /\d{1,2}[\/\-\.]\d{1,2}[\/\-\.]\d{4}/.test(trimmedCell)) {
                        const parsedDate = parseDate(trimmedCell);
                        if (parsedDate) {
                            date = parsedDate;
                            dateCell = trimmedCell;
                            continue;
                        }
                    }
                    
                    // Chercher un montant (contient des chiffres et éventuellement € ou ,)
                    if (!amount && /\d/.test(trimmedCell)) {
                        const parsedAmount = parseAmount(trimmedCell);
                        if (parsedAmount) {
                            amount = parsedAmount;
                            amountCell = trimmedCell;
                            continue;
                        }
                    }
                }

                // Deuxième passe: chercher une référence (texte qui n'est ni date ni montant)
                for (let cell of cells) {
                    const trimmedCell = cell.trim();
                    if (trimmedCell !== dateCell && trimmedCell !== amountCell && trimmedCell.length > 0) {
                        reference = trimmedCell;
                        break;
                    }
                }

                // Créer une entrée si on a trouvé au moins date ET montant
                if (amount && date) {
                    debts.push({
                        amount,
                        date,
                        reference: reference || `Dette ${debts.length + 1}`,
                        lineNumber: index + 1
                    });
                } else {
                    // Erreur détaillée pour le debug
                    let errorMsg = `Ligne ${index + 1}: `;
                    if (!amount && !date) {
                        errorMsg += `Ni date ni montant trouvé (contenu: "${line.substring(0, 50)}...")`;
                    } else if (!amount) {
                        errorMsg += `Montant introuvable (date trouvée: ${dateCell})`;
                    } else if (!date) {
                        errorMsg += `Date introuvable (montant trouvé: ${amountCell})`;
                    }
                    errors.push(errorMsg);
                }
            });

            return { debts, errors };
        };

        // Taux d'intérêt légaux
        const legalRates = {
            '2025-S2': { particulier: 6.65, professionnel: 2.76 },
            '2025-S1': { particulier: 7.21, professionnel: 3.71 },
            '2024-S2': { particulier: 8.16, professionnel: 4.92 },
            '2024-S1': { particulier: 8.01, professionnel: 4.92 },
            '2023-S2': { particulier: 6.82, professionnel: 4.47 },
            '2023-S1': { particulier: 3.15, professionnel: 3.15 },
            '2022-S2': { particulier: 3.15, professionnel: 3.15 },
            '2022-S1': { particulier: 3.13, professionnel: 3.13 },
            '2021-S2': { particulier: 3.12, professionnel: 3.12 },
            '2021-S1': { particulier: 3.14, professionnel: 3.14 },
            '2020-S2': { particulier: 3.11, professionnel: 3.11 },
            '2020-S1': { particulier: 3.15, professionnel: 3.15 },
            '2019-S2': { particulier: 3.26, professionnel: 3.26 },
            '2019-S1': { particulier: 3.40, professionnel: 3.40 },
            '2018-S2': { particulier: 3.60, professionnel: 3.60 },
            '2018-S1': { particulier: 3.73, professionnel: 3.73 },
            '2017-S2': { particulier: 3.94, professionnel: 3.94 },
            '2017-S1': { particulier: 4.16, professionnel: 4.16 },
            '2016-S2': { particulier: 4.35, professionnel: 4.35 },
            '2016-S1': { particulier: 4.54, professionnel: 4.54 },
            '2015-S2': { particulier: 4.06, professionnel: 0.93 },
            '2015-S1': { particulier: 4.29, professionnel: 0.93 },
            '2014-S2': { particulier: 4.54, professionnel: 4.54 },
            '2014-S1': { particulier: 4.80, professionnel: 4.80 },
            '2013-S2': { particulier: 4.80, professionnel: 4.80 },
            '2013-S1': { particulier: 4.80, professionnel: 4.80 }
        };

        // Fonction de calcul principale
        const calculateInterest = (debtAmount, exigibilityDate, creditorType, capitalization, isJudgment, judgmentDate, calculationDate = new Date()) => {
            const startDate = new Date(exigibilityDate);
            const endDate = calculationDate;
            
            let currentAmount = debtAmount;
            let totalInterest = 0;
            let currentDate = new Date(startDate);
            const interestDetails = [];
            const detailsBySemester = [];
            const chartData = [];

            let judgmentApplied = false;
            const judgmentDateObj = isJudgment && judgmentDate ? new Date(judgmentDate) : null;

            while (currentDate < endDate) {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const semester = month < 6 ? 'S1' : 'S2';
                const semesterKey = `${year}-${semester}`;

                const nextSemesterDate = new Date(year, semester === 'S1' ? 6 : 12, 1);
                const periodEnd = nextSemesterDate > endDate ? endDate : nextSemesterDate;

                const daysDiff = Math.floor((periodEnd - currentDate) / (1000 * 60 * 60 * 24));

                if (daysDiff > 0) {
                    const baseRate = legalRates[semesterKey]?.[creditorType] || 4.0;
                    
                    // Vérifier si la majoration doit s'appliquer
                    let rate = baseRate;
                    let isMajorated = false;
                    
                    if (isJudgment && judgmentDateObj) {
                        const twoMonthsAfterJudgment = new Date(judgmentDateObj);
                        twoMonthsAfterJudgment.setMonth(twoMonthsAfterJudgment.getMonth() + 2);
                        
                        if (currentDate >= twoMonthsAfterJudgment && !judgmentApplied) {
                            rate = baseRate + 5;
                            isMajorated = true;
                            judgmentApplied = true;
                        } else if (judgmentApplied) {
                            rate = baseRate + 5;
                            isMajorated = true;
                        }
                    }

                    const interest = (currentAmount * rate * daysDiff) / (365 * 100);
                    totalInterest += interest;

                    interestDetails.push({
                        period: `${currentDate.toLocaleDateString('fr-FR')} - ${periodEnd.toLocaleDateString('fr-FR')}`,
                        semester: `${semester} ${year}`,
                        days: daysDiff,
                        rate: rate.toFixed(2),
                        amount: currentAmount,
                        interest: interest,
                        isMajorated: isMajorated
                    });

                    chartData.push({
                        date: periodEnd.toLocaleDateString('fr-FR'),
                        debtTotal: currentAmount + totalInterest,
                        interest: totalInterest
                    });

                    // Capitalisation semestrielle
                    if (capitalization && periodEnd.getTime() === nextSemesterDate.getTime() && nextSemesterDate < endDate) {
                        detailsBySemester.push({
                            semester: `${semester} ${year}`,
                            interestAdded: interest,
                            capitalizedAmount: currentAmount + interest
                        });
                        currentAmount += interest;
                    }
                }

                currentDate = new Date(periodEnd);
            }

            return {
                debtAmount,
                totalInterest,
                totalAmount: debtAmount + totalInterest,
                interestDetails,
                detailsBySemester,
                chartData,
                startDate: startDate.toLocaleDateString('fr-FR'),
                endDate: endDate.toLocaleDateString('fr-FR'),
                durationDays: Math.floor((endDate - startDate) / (1000 * 60 * 60 * 24))
            };
        };

        // Composant principal
        const DebtInterestCalculator = () => {
            const [mode, setMode] = useState('single'); // 'single' ou 'excel'
            const [debtAmount, setDebtAmount] = useState('');
            const [exigibilityDate, setExigibilityDate] = useState('');
            const [creditorType, setCreditorType] = useState('particulier');
            const [capitalization, setCapitalization] = useState(true);
            const [isJudgment, setIsJudgment] = useState(false);
            const [judgmentDate, setJudgmentDate] = useState('');
            const [results, setResults] = useState(null);
            
            // États pour l'import Excel
            const [excelData, setExcelData] = useState('');
            const [parsedDebts, setParsedDebts] = useState([]);
            const [parseErrors, setParseErrors] = useState([]);
            const [multiResults, setMultiResults] = useState([]);
            const [showPreview, setShowPreview] = useState(false);

            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            const textareaRef = useRef(null);

            // Gestion du collage
            const handlePaste = (e) => {
                const text = e.clipboardData.getData('text');
                setExcelData(text);
                
                // Parser automatiquement
                const { debts, errors } = parseExcelData(text);
                setParsedDebts(debts);
                setParseErrors(errors);
                setShowPreview(true);
            };

            // Calculer toutes les dettes
            const calculateAllDebts = () => {
                const results = parsedDebts.map(debt => ({
                    ...debt,
                    calculation: calculateInterest(
                        debt.amount,
                        debt.date,
                        creditorType,
                        capitalization,
                        isJudgment,
                        judgmentDate
                    )
                }));
                setMultiResults(results);
            };

            // Calculer une seule dette
            const handleCalculate = () => {
                if (!debtAmount || !exigibilityDate) return;

                const result = calculateInterest(
                    parseFloat(debtAmount),
                    exigibilityDate,
                    creditorType,
                    capitalization,
                    isJudgment,
                    judgmentDate
                );
                setResults(result);
            };

            // Effet pour le graphique
            useEffect(() => {
                if (results && chartRef.current) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = chartRef.current.getContext('2d');
                    chartInstance.current = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: results.chartData.map(d => d.date),
                            datasets: [{
                                label: 'Montant total dû (€)',
                                data: results.chartData.map(d => d.debtTotal),
                                borderColor: 'rgb(59, 130, 246)',
                                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                                tension: 0.4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: true },
                                tooltip: {
                                    callbacks: {
                                        label: (context) => `${context.parsed.y.toFixed(2)} €`
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: false,
                                    ticks: {
                                        callback: (value) => `${value.toFixed(0)} €`
                                    }
                                }
                            }
                        }
                    });
                }
            }, [results]);

            // Générer PDF professionnel
            const generatePDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const pageWidth = doc.internal.pageSize.width;
                const pageHeight = doc.internal.pageSize.height;
                let y = 20;

                // Fonction pour extraire les taux utilisés
                const extractUsedRates = (interestDetails) => {
                    const ratesMap = new Map();
                    interestDetails.forEach(detail => {
                        const key = detail.semester;
                        if (!ratesMap.has(key)) {
                            ratesMap.set(key, {
                                semester: detail.semester,
                                rate: parseFloat(detail.rate),
                                isMajorated: detail.isMajorated || false
                            });
                        }
                    });
                    return Array.from(ratesMap.values()).sort((a, b) => {
                        const [yearA, semA] = a.semester.split(' ');
                        const [yearB, semB] = b.semester.split(' ');
                        if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
                        return semA.localeCompare(semB);
                    });
                };

                if (mode === 'single' && results) {
                    // ===== EN-TÊTE =====
                    doc.setFillColor(66, 135, 245);
                    doc.setTextColor(66, 135, 245);
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('RAPPORT DE CALCUL D\'INTÉRÊTS DE RETARD', pageWidth / 2, y, { align: 'center' });
                    
                    y += 10;
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text('Selon le taux d\'intérêt légal français', pageWidth / 2, y, { align: 'center' });
                    
                    y += 6;
                    const now = new Date();
                    doc.setFontSize(9);
                    doc.text(`Document généré le ${now.toLocaleDateString('fr-FR')} à ${now.toLocaleTimeString('fr-FR')}`, pageWidth / 2, y, { align: 'center' });
                    
                    // Ligne de séparation
                    y += 8;
                    doc.setDrawColor(66, 135, 245);
                    doc.setLineWidth(0.5);
                    doc.line(15, y, pageWidth - 15, y);
                    
                    // ===== SECTION 1: INFORMATIONS GÉNÉRALES =====
                    y += 10;
                    doc.setFontSize(13);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'bold');
                    doc.text('1. INFORMATIONS GÉNÉRALES DE LA CRÉANCE', 15, y);
                    
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Montant initial de la dette : ${results.debtAmount.toFixed(2)} €`, 20, y);
                    y += 6;
                    doc.text(`Date d'exigibilité : ${exigibilityDate}`, 20, y);
                    y += 6;
                    doc.text(`Date de calcul : ${now.toLocaleDateString('fr-FR')}`, 20, y);
                    y += 6;
                    doc.text(`Type de créancier : ${creditorType === 'particulier' ? 'Particulier' : 'Professionnel'}`, 20, y);
                    y += 6;
                    doc.text(`Capitalisation : ${capitalization ? 'Activée' : 'Désactivée'}`, 20, y);
                    
                    if (isJudgment && judgmentDate) {
                        y += 6;
                        doc.setTextColor(200, 0, 0);
                        doc.setFont(undefined, 'bold');
                        doc.text(`⚖ Condamnation judiciaire : ${judgmentDate} (majoration +5 points)`, 20, y);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');
                    }
                    
                    // ===== ENCADRÉ MONTANT TOTAL =====
                    y += 12;
                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(25, y, pageWidth - 50, 25, 3, 3, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.text('MONTANT TOTAL À RÉGLER', pageWidth / 2, y + 8, { align: 'center' });
                    
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${results.totalAmount.toFixed(2)} €`, pageWidth / 2, y + 17, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    const interestText = capitalization 
                        ? `Dont ${results.totalInterest.toFixed(2)} € d'intérêts de retard (capitalisés)`
                        : `Dont ${results.totalInterest.toFixed(2)} € d'intérêts de retard (intérêts simples)`;
                    doc.text(interestText, pageWidth / 2, y + 22, { align: 'center' });
                    
                    // ===== SECTION 2: RÉSUMÉ FINANCIER =====
                    y += 35;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('2. RÉSUMÉ FINANCIER', 15, y);
                    
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Dette initiale : ${results.debtAmount.toFixed(2)} €`, 20, y);
                    y += 6;
                    doc.text(`Intérêts de retard : ${results.totalInterest.toFixed(2)} €`, 20, y);
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(59, 130, 246);
                    doc.text(`TOTAL DÛ : ${results.totalAmount.toFixed(2)} €`, 20, y);
                    
                    // ===== SECTION 3: DÉTAIL DES CALCULS =====
                    y += 12;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('3. DÉTAIL DES CALCULS D\'INTÉRÊTS', 15, y);
                    
                    // En-têtes du tableau
                    y += 8;
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('Période', 17, y);
                    doc.text('Semestre', 60, y);
                    doc.text('Capital (€)', 100, y);
                    doc.text('Taux (%)', 130, y);
                    doc.text('Jours', 155, y);
                    doc.text('Intérêts (€)', 175, y);
                    
                    y += 5;
                    doc.setFont(undefined, 'normal');
                    
                    // Lignes du tableau
                    results.interestDetails.forEach((detail, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Répéter l'en-tête
                            doc.setFillColor(240, 240, 240);
                            doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            doc.text('Période', 17, y);
                            doc.text('Semestre', 60, y);
                            doc.text('Capital (€)', 100, y);
                            doc.text('Taux (%)', 130, y);
                            doc.text('Jours', 155, y);
                            doc.text('Intérêts (€)', 175, y);
                            y += 5;
                            doc.setFont(undefined, 'normal');
                        }
                        
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 4, pageWidth - 30, 6, 'F');
                        }
                        
                        doc.setFontSize(7);
                        doc.text(detail.period, 17, y);
                        doc.text(detail.semester, 60, y);
                        doc.text(detail.amount.toFixed(2), 100, y);
                        
                        if (detail.isMajorated) {
                            doc.setTextColor(200, 0, 0);
                            doc.text(`${detail.rate}`, 130, y);
                            doc.setTextColor(0, 0, 0);
                        } else {
                            doc.text(detail.rate, 130, y);
                        }
                        
                        doc.text(detail.days.toString(), 155, y);
                        doc.text(detail.interest.toFixed(2), 175, y);
                        
                        y += 5;
                    });
                    
                    // Total des intérêts
                    y += 3;
                    doc.setDrawColor(0, 0, 0);
                    doc.setLineWidth(0.5);
                    doc.line(15, y, pageWidth - 15, y);
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.setTextColor(59, 130, 246);
                    doc.text(`TOTAL DES INTÉRÊTS : ${results.totalInterest.toFixed(2)} €`, pageWidth - 15, y, { align: 'right' });
                    
                    // Nouvelle page pour les taux si besoin
                    if (y > pageHeight - 100) {
                        doc.addPage();
                        y = 20;
                    } else {
                        y += 15;
                    }
                    
                    // ===== SECTION 3.5: TAUX D'INTÉRÊT UTILISÉS =====
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('3.5. TAUX D\'INTÉRÊT LÉGAUX APPLIQUÉS', 15, y);
                    
                    y += 8;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Type de créancier : ${creditorType === 'particulier' ? 'Particulier / Commerçant' : 'Professionnel (B2B)'}`, 15, y);
                    
                    y += 6;
                    const usedRates = extractUsedRates(results.interestDetails);
                    
                    // En-têtes du tableau des taux
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Période', 20, y);
                    doc.text('Taux appliqué', 80, y);
                    doc.text('Base légale', 130, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    
                    usedRates.forEach((rateInfo, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Répéter l'en-tête
                            doc.setFillColor(240, 240, 240);
                            doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.text('Période', 20, y);
                            doc.text('Taux appliqué', 80, y);
                            doc.text('Base légale', 130, y);
                            y += 6;
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                        }
                        
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 4, pageWidth - 30, 6, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(rateInfo.semester, 20, y);
                        
                        if (rateInfo.isMajorated) {
                            doc.setTextColor(200, 0, 0);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${rateInfo.rate.toFixed(2)}% (+5pts majoration)`, 80, y);
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(0, 0, 0);
                            doc.text('Art. L.313-3 CMF', 130, y);
                        } else {
                            doc.text(`${rateInfo.rate.toFixed(2)}%`, 80, y);
                            
                            // Déterminer la base légale selon le semestre
                            const year = parseInt(rateInfo.semester.split(' ')[1]);
                            let baseLegale = 'Art. L.313-2 CMF';
                            if (year >= 2025) baseLegale = 'Arrêté 19/06/2025';
                            else if (year >= 2024) baseLegale = 'Arrêté 26/06/2024';
                            else if (year >= 2023) baseLegale = 'Arrêté 27/06/2023';
                            else if (year >= 2015) baseLegale = 'Ordonnance 2014-947';
                            
                            doc.text(baseLegale, 130, y);
                        }
                        
                        y += 5;
                    });
                    
                    // Note explicative
                    y += 5;
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFillColor(245, 247, 250);
                    doc.roundedRect(15, y - 3, pageWidth - 30, 12, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont(undefined, 'italic');
                    const noteText = doc.splitTextToSize(
                        'Note : Les taux d\'intérêt légaux sont fixés par arrêté ministériel et publiés au Journal Officiel. Ils sont révisés semestriellement depuis 2015 et diffèrent selon la qualité du créancier (particulier ou professionnel).',
                        pageWidth - 40
                    );
                    doc.text(noteText, 20, y + 1);
                    
                    // Nouvelle page pour les références légales si besoin
                    if (y > pageHeight - 80) {
                        doc.addPage();
                        y = 20;
                    } else {
                        y += 15;
                    }
                    
                    // ===== SECTION 4: RÉFÉRENCES LÉGALES =====
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('4. RÉFÉRENCES LÉGALES ET MÉTHODOLOGIE', 15, y);
                    
                    y += 10;
                    doc.setFontSize(10);
                    doc.text('Base légale :', 15, y);
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    y += 6;
                    const legalRefs = [
                        '• Articles L. 313-2 et suivants du Code monétaire et financier',
                        '• Loi n° 75-619 du 11 juillet 1975, article 3 (majoration)',
                        '• Ordonnance n° 2014-947 du 20 août 2014 (réforme du taux)',
                        '• Décret n° 2014-1115 du 2 octobre 2014 (modalités de calcul)',
                        '• Arrêté du 19 juin 2025 (taux S2 2025)'
                    ];
                    legalRefs.forEach(ref => {
                        doc.text(ref, 20, y);
                        y += 5;
                    });
                    
                    y += 5;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('Formule de calcul appliquée :', 15, y);
                    
                    y += 6;
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(20, y - 3, pageWidth - 40, 10, 2, 2, 'F');
                    doc.setFont(undefined, 'italic');
                    doc.setFontSize(9);
                    doc.text('Intérêts = (Capital × Taux d\'intérêt légal × Nombre de jours) ÷ (365 × 100)', pageWidth / 2, y + 2, { align: 'center' });
                    
                    y += 12;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('Principes appliqués :', 15, y);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    y += 6;
                    const principles = [
                        '• Taux semestriels distincts depuis 2015, taux annuels avant',
                        '• Distinction entre créanciers particuliers et professionnels',
                        `• Capitalisation ${capitalization ? 'activée' : 'désactivée'} des intérêts`,
                        '• Calcul sur base 365 jours conformément à la réglementation',
                        '• Taux S2 2025 en vigueur depuis le 1er juillet 2025'
                    ];
                    principles.forEach(principle => {
                        doc.text(principle, 20, y);
                        y += 5;
                    });
                    
                    // Encadré important
                    y += 8;
                    doc.setFillColor(255, 243, 205);
                    doc.setDrawColor(245, 158, 11);
                    doc.roundedRect(15, y - 3, pageWidth - 30, 15, 2, 2, 'FD');
                    
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('IMPORTANT :', 20, y + 2);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    const importantText = doc.splitTextToSize(
                        'Ce calcul est effectué selon la réglementation française en vigueur. En cas de condamnation judiciaire, le taux peut être majoré de 5 points après 2 mois.',
                        pageWidth - 50
                    );
                    doc.text(importantText, 20, y + 7);
                    
                    // Pied de page
                    y = pageHeight - 20;
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    doc.text('Document généré automatiquement • Calcul conforme à la réglementation française', pageWidth / 2, y, { align: 'center' });
                    y += 4;
                    doc.text('Taux S2 2025 : Arrêté du 19 juin 2025 • Particuliers: 6,65% • Professionnels: 2,76%', pageWidth / 2, y, { align: 'center' });
                    
                } else if (mode === 'excel' && multiResults.length > 0) {
                    // Export pour mode Excel (multi-dettes)
                    const now = new Date();
                    
                    // ===== EN-TÊTE =====
                    doc.setFillColor(66, 135, 245);
                    doc.setTextColor(66, 135, 245);
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text('RAPPORT DE CALCULS MULTIPLES', pageWidth / 2, y, { align: 'center' });
                    
                    y += 8;
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text('Selon le taux d\'intérêt légal français', pageWidth / 2, y, { align: 'center' });
                    
                    y += 6;
                    doc.setFontSize(9);
                    doc.text(`Document généré le ${now.toLocaleDateString('fr-FR')} à ${now.toLocaleTimeString('fr-FR')}`, pageWidth / 2, y, { align: 'center' });
                    
                    y += 8;
                    doc.setDrawColor(66, 135, 245);
                    doc.setLineWidth(0.5);
                    doc.line(15, y, pageWidth - 15, y);
                    
                    // ===== SECTION 1: INFORMATIONS GÉNÉRALES =====
                    y += 10;
                    doc.setFontSize(13);
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'bold');
                    doc.text('1. INFORMATIONS GÉNÉRALES', 15, y);
                    
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Nombre de créances : ${multiResults.length}`, 20, y);
                    y += 6;
                    doc.text(`Type de créancier : ${creditorType === 'particulier' ? 'Particulier' : 'Professionnel'}`, 20, y);
                    y += 6;
                    doc.text(`Capitalisation : ${capitalization ? 'Activée' : 'Désactivée'}`, 20, y);
                    y += 6;
                    doc.text(`Date de calcul : ${now.toLocaleDateString('fr-FR')}`, 20, y);
                    
                    // ===== ENCADRÉ TOTAUX GLOBAUX =====
                    y += 12;
                    const totalCapital = multiResults.reduce((sum, r) => sum + r.calculation.debtAmount, 0);
                    const totalInterests = multiResults.reduce((sum, r) => sum + r.calculation.totalInterest, 0);
                    const grandTotal = multiResults.reduce((sum, r) => sum + r.calculation.totalAmount, 0);
                    
                    doc.setFillColor(59, 130, 246);
                    doc.roundedRect(25, y, pageWidth - 50, 25, 3, 3, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(11);
                    doc.text('MONTANT TOTAL À RÉGLER', pageWidth / 2, y + 8, { align: 'center' });
                    
                    doc.setFontSize(20);
                    doc.setFont(undefined, 'bold');
                    doc.text(`${grandTotal.toFixed(2)} €`, pageWidth / 2, y + 17, { align: 'center' });
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Dont ${totalInterests.toFixed(2)} € d'intérêts de retard`, pageWidth / 2, y + 22, { align: 'center' });
                    
                    // ===== SECTION 2: RÉSUMÉ FINANCIER =====
                    y += 35;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('2. RÉSUMÉ FINANCIER GLOBAL', 15, y);
                    
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Capital total : ${totalCapital.toFixed(2)} €`, 20, y);
                    y += 6;
                    doc.text(`Intérêts totaux : ${totalInterests.toFixed(2)} €`, 20, y);
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(59, 130, 246);
                    doc.text(`TOTAL DÛ : ${grandTotal.toFixed(2)} €`, 20, y);
                    
                    // ===== SECTION 3: DÉTAIL PAR CRÉANCE =====
                    y += 12;
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('3. DÉTAIL PAR CRÉANCE', 15, y);
                    
                    y += 8;
                    // En-têtes du tableau
                    doc.setFillColor(59, 130, 246);
                    doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('N°', 17, y);
                    doc.text('Référence', 25, y);
                    doc.text('Date exigibilité', 65, y);
                    doc.text('Durée (j)', 105, y);
                    doc.text('Capital (€)', 130, y);
                    doc.text('Intérêts (€)', 160, y);
                    doc.text('Total (€)', pageWidth - 17, y, { align: 'right' });
                    
                    y += 6;
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    
                    // Lignes du tableau
                    multiResults.forEach((item, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Répéter l'en-tête
                            doc.setFillColor(59, 130, 246);
                            doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.setFontSize(8);
                            doc.setFont(undefined, 'bold');
                            doc.text('N°', 17, y);
                            doc.text('Référence', 25, y);
                            doc.text('Date exigibilité', 65, y);
                            doc.text('Durée (j)', 105, y);
                            doc.text('Capital (€)', 130, y);
                            doc.text('Intérêts (€)', 160, y);
                            doc.text('Total (€)', pageWidth - 17, y, { align: 'right' });
                            y += 6;
                            doc.setTextColor(0, 0, 0);
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                        }
                        
                        // Alternance de couleurs
                        if (index % 2 === 0) {
                            doc.setFillColor(248, 250, 252);
                            doc.rect(15, y - 4, pageWidth - 30, 6, 'F');
                        }
                        
                        // Contenu de la ligne
                        doc.text(`${index + 1}`, 17, y);
                        
                        // Référence (tronquer si trop longue)
                        const refText = item.reference.length > 18 ? item.reference.substring(0, 16) + '...' : item.reference;
                        doc.text(refText, 25, y);
                        
                        doc.text(new Date(item.date).toLocaleDateString('fr-FR'), 65, y);
                        doc.text(item.calculation.durationDays.toString(), 105, y);
                        doc.text(item.calculation.debtAmount.toFixed(2), 130, y);
                        doc.text(item.calculation.totalInterest.toFixed(2), 160, y);
                        
                        // Total en bleu et gras, aligné à droite
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(59, 130, 246);
                        doc.text(item.calculation.totalAmount.toFixed(2), pageWidth - 17, y, { align: 'right' });
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'normal');
                        
                        y += 5;
                    });
                    
                    // Ligne de séparation et totaux
                    y += 2;
                    doc.setDrawColor(59, 130, 246);
                    doc.setLineWidth(0.5);
                    doc.line(15, y, pageWidth - 15, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('TOTAUX', 25, y);
                    doc.text(totalCapital.toFixed(2), 130, y);
                    doc.text(totalInterests.toFixed(2), 160, y);
                    doc.setTextColor(59, 130, 246);
                    doc.setFontSize(10);
                    doc.text(grandTotal.toFixed(2), pageWidth - 17, y, { align: 'right' });
                    doc.setTextColor(0, 0, 0);
                    doc.setFont(undefined, 'normal');
                    
                    // Vérifier si on a besoin d'une nouvelle page pour les références légales
                    if (y > pageHeight - 100) {
                        doc.addPage();
                        y = 20;
                    } else {
                        y += 10;
                    }
                    
                    // ===== SECTION 4: DÉTAIL DES CALCULS (OPTIONNEL - Première dette en exemple) =====
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('4. EXEMPLE DE CALCUL DÉTAILLÉ (1ère créance)', 15, y);
                    
                    y += 8;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text('Le calcul détaillé de la première créance est présenté ci-dessous. Les autres créances suivent la même méthodologie.', 15, y);
                    
                    y += 8;
                    // En-têtes du tableau
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                    
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Période', 17, y);
                    doc.text('Semestre', 55, y);
                    doc.text('Capital (€)', 90, y);
                    doc.text('Taux (%)', 120, y);
                    doc.text('Jours', 145, y);
                    doc.text('Intérêts (€)', 165, y);
                    
                    y += 5;
                    doc.setFont(undefined, 'normal');
                    
                    // Afficher les 10 premières lignes du premier calcul
                    const firstDebtDetails = multiResults[0].calculation.interestDetails.slice(0, 10);
                    firstDebtDetails.forEach((detail, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                        }
                        
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 4, pageWidth - 30, 6, 'F');
                        }
                        
                        doc.setFontSize(7);
                        doc.text(detail.period.length > 23 ? detail.period.substring(0, 23) : detail.period, 17, y);
                        doc.text(detail.semester, 55, y);
                        doc.text(detail.amount.toFixed(2), 90, y);
                        doc.text(detail.rate, 120, y);
                        doc.text(detail.days.toString(), 145, y);
                        doc.text(detail.interest.toFixed(2), 165, y);
                        
                        y += 5;
                    });
                    
                    if (multiResults[0].calculation.interestDetails.length > 10) {
                        doc.setFontSize(8);
                        doc.setTextColor(100, 100, 100);
                        doc.text(`... et ${multiResults[0].calculation.interestDetails.length - 10} périodes supplémentaires`, 17, y);
                        y += 6;
                    }
                    
                    // Nouvelle page pour les taux si nécessaire
                    if (y > pageHeight - 100) {
                        doc.addPage();
                        y = 20;
                    } else {
                        y += 10;
                    }
                    
                    // ===== SECTION 4.5: TAUX D'INTÉRÊT UTILISÉS =====
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('4.5. TAUX D\'INTÉRÊT LÉGAUX APPLIQUÉS', 15, y);
                    
                    y += 8;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    doc.text(`Type de créancier : ${creditorType === 'particulier' ? 'Particulier / Commerçant' : 'Professionnel (B2B)'}`, 15, y);
                    
                    y += 6;
                    // Extraire tous les taux uniques de toutes les dettes
                    const allRatesMap = new Map();
                    multiResults.forEach(result => {
                        result.calculation.interestDetails.forEach(detail => {
                            const key = detail.semester;
                            if (!allRatesMap.has(key)) {
                                allRatesMap.set(key, {
                                    semester: detail.semester,
                                    rate: parseFloat(detail.rate),
                                    isMajorated: detail.isMajorated || false
                                });
                            }
                        });
                    });
                    
                    const allUsedRates = Array.from(allRatesMap.values()).sort((a, b) => {
                        const [yearA, semA] = a.semester.split(' ');
                        const [yearB, semB] = b.semester.split(' ');
                        if (yearA !== yearB) return parseInt(yearA) - parseInt(yearB);
                        return semA.localeCompare(semB);
                    });
                    
                    // En-têtes du tableau des taux
                    doc.setFillColor(240, 240, 240);
                    doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Période', 20, y);
                    doc.text('Taux appliqué', 80, y);
                    doc.text('Base légale', 130, y);
                    
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    
                    allUsedRates.forEach((rateInfo, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = 20;
                            
                            // Répéter l'en-tête
                            doc.setFillColor(240, 240, 240);
                            doc.rect(15, y - 4, pageWidth - 30, 8, 'F');
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.text('Période', 20, y);
                            doc.text('Taux appliqué', 80, y);
                            doc.text('Base légale', 130, y);
                            y += 6;
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(8);
                        }
                        
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(15, y - 4, pageWidth - 30, 6, 'F');
                        }
                        
                        doc.setTextColor(0, 0, 0);
                        doc.text(rateInfo.semester, 20, y);
                        
                        if (rateInfo.isMajorated) {
                            doc.setTextColor(200, 0, 0);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${rateInfo.rate.toFixed(2)}% (+5pts majoration)`, 80, y);
                            doc.setFont(undefined, 'normal');
                            doc.setTextColor(0, 0, 0);
                            doc.text('Art. L.313-3 CMF', 130, y);
                        } else {
                            doc.text(`${rateInfo.rate.toFixed(2)}%`, 80, y);
                            
                            // Déterminer la base légale selon le semestre
                            const year = parseInt(rateInfo.semester.split(' ')[1]);
                            let baseLegale = 'Art. L.313-2 CMF';
                            if (year >= 2025) baseLegale = 'Arrêté 19/06/2025';
                            else if (year >= 2024) baseLegale = 'Arrêté 26/06/2024';
                            else if (year >= 2023) baseLegale = 'Arrêté 27/06/2023';
                            else if (year >= 2015) baseLegale = 'Ordonnance 2014-947';
                            
                            doc.text(baseLegale, 130, y);
                        }
                        
                        y += 5;
                    });
                    
                    // Note explicative
                    y += 5;
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFillColor(245, 247, 250);
                    doc.roundedRect(15, y - 3, pageWidth - 30, 12, 2, 2, 'F');
                    doc.setFontSize(7);
                    doc.setTextColor(100, 100, 100);
                    doc.setFont(undefined, 'italic');
                    const noteText = doc.splitTextToSize(
                        'Note : Les taux d\'intérêt légaux sont fixés par arrêté ministériel et publiés au Journal Officiel. Ils sont révisés semestriellement depuis 2015 et diffèrent selon la qualité du créancier (particulier ou professionnel).',
                        pageWidth - 40
                    );
                    doc.text(noteText, 20, y + 1);
                    
                    // Nouvelle page pour références légales si nécessaire
                    if (y > pageHeight - 80) {
                        doc.addPage();
                        y = 20;
                    } else {
                        y += 10;
                    }
                    
                    // ===== SECTION 5: RÉFÉRENCES LÉGALES =====
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(13);
                    doc.setFont(undefined, 'bold');
                    doc.text('5. RÉFÉRENCES LÉGALES ET MÉTHODOLOGIE', 15, y);
                    
                    y += 10;
                    doc.setFontSize(10);
                    doc.text('Base légale :', 15, y);
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    y += 6;
                    const legalRefs = [
                        '• Articles L. 313-2 et suivants du Code monétaire et financier',
                        '• Loi n° 75-619 du 11 juillet 1975, article 3 (majoration)',
                        '• Ordonnance n° 2014-947 du 20 août 2014 (réforme du taux)',
                        '• Décret n° 2014-1115 du 2 octobre 2014 (modalités de calcul)',
                        '• Arrêté du 19 juin 2025 (taux S2 2025)'
                    ];
                    legalRefs.forEach(ref => {
                        if (y > pageHeight - 20) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(ref, 20, y);
                        y += 5;
                    });
                    
                    y += 5;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('Formule de calcul appliquée :', 15, y);
                    
                    y += 6;
                    doc.setFillColor(250, 250, 250);
                    doc.roundedRect(20, y - 3, pageWidth - 40, 10, 2, 2, 'F');
                    doc.setFont(undefined, 'italic');
                    doc.setFontSize(9);
                    doc.text('Intérêts = (Capital × Taux d\'intérêt légal × Nombre de jours) ÷ (365 × 100)', pageWidth / 2, y + 2, { align: 'center' });
                    
                    y += 12;
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text('Principes appliqués :', 15, y);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    y += 6;
                    const principles = [
                        '• Taux semestriels distincts depuis 2015, taux annuels avant',
                        '• Distinction entre créanciers particuliers et professionnels',
                        `• Capitalisation ${capitalization ? 'activée' : 'désactivée'} des intérêts`,
                        '• Calcul sur base 365 jours conformément à la réglementation',
                        '• Taux S2 2025 en vigueur depuis le 1er juillet 2025'
                    ];
                    principles.forEach(principle => {
                        if (y > pageHeight - 20) {
                            doc.addPage();
                            y = 20;
                        }
                        doc.text(principle, 20, y);
                        y += 5;
                    });
                    
                    // Encadré important
                    y += 8;
                    if (y > pageHeight - 30) {
                        doc.addPage();
                        y = 20;
                    }
                    
                    doc.setFillColor(255, 243, 205);
                    doc.setDrawColor(245, 158, 11);
                    doc.roundedRect(15, y - 3, pageWidth - 30, 15, 2, 2, 'FD');
                    
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(9);
                    doc.text('IMPORTANT :', 20, y + 2);
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(8);
                    const importantText = doc.splitTextToSize(
                        'Ce calcul est effectué selon la réglementation française en vigueur. En cas de condamnation judiciaire, le taux peut être majoré de 5 points après 2 mois.',
                        pageWidth - 50
                    );
                    doc.text(importantText, 20, y + 7);
                    
                    // Pied de page sur toutes les pages
                    const totalPages = doc.internal.pages.length - 1;
                    for (let i = 1; i <= totalPages; i++) {
                        doc.setPage(i);
                        y = pageHeight - 15;
                        doc.setFontSize(7);
                        doc.setTextColor(100, 100, 100);
                        doc.text('Document généré automatiquement • Calcul conforme à la réglementation française', pageWidth / 2, y, { align: 'center' });
                        y += 4;
                        doc.text('Taux S2 2025 : Arrêté du 19 juin 2025 • Particuliers: 6,65% • Professionnels: 2,76%', pageWidth / 2, y, { align: 'center' });
                        y += 4;
                        doc.text(`Page ${i} sur ${totalPages}`, pageWidth / 2, y, { align: 'center' });
                    }
                }

                doc.save('rapport-interets-retard.pdf');
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 py-8 px-4">
                    <div className="max-w-7xl mx-auto">
                        {/* En-tête */}
                        <div className="text-center mb-8 animate-slide-in">
                            <h1 className="text-4xl font-bold text-gray-900 mb-2">
                                Calculateur d'Intérêts de Retard
                            </h1>
                            <p className="text-gray-600">Version 3.0 - Conforme aux dispositions du Code monétaire et financier</p>
                            <div className="mt-4 inline-flex items-center gap-2 bg-green-100 text-green-800 px-4 py-2 rounded-full text-sm font-medium">
                                <CheckCircle className="w-4 h-4" />
                                Taux S2 2025 à jour (Arrêté du 19 juin 2025)
                            </div>
                        </div>

                        {/* Sélection du mode */}
                        <div className="bg-white rounded-xl shadow-lg p-6 mb-6 animate-slide-in">
                            <div className="flex gap-4 justify-center">
                                <button
                                    onClick={() => setMode('single')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${
                                        mode === 'single'
                                            ? 'bg-blue-600 text-white shadow-lg scale-105'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    <Calculator className="w-5 h-5" />
                                    Calcul unique
                                </button>
                                <button
                                    onClick={() => setMode('excel')}
                                    className={`flex items-center gap-2 px-6 py-3 rounded-lg font-medium transition-all ${
                                        mode === 'excel'
                                            ? 'bg-green-600 text-white shadow-lg scale-105'
                                            : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                    }`}
                                >
                                    <Table className="w-5 h-5" />
                                    Import Excel
                                </button>
                            </div>
                        </div>

                        {/* Mode calcul unique */}
                        {mode === 'single' && (
                            <div className="bg-white rounded-xl shadow-lg p-6 mb-6 animate-slide-in">
                                <h2 className="text-2xl font-bold text-gray-900 mb-6">Calcul d'une dette</h2>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            <Euro className="inline w-4 h-4 mr-1" />
                                            Montant de la dette (€)
                                        </label>
                                        <input
                                            type="number"
                                            step="0.01"
                                            value={debtAmount}
                                            onChange={(e) => setDebtAmount(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                            placeholder="1000.00"
                                        />
                                    </div>

                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            <Calendar className="inline w-4 h-4 mr-1" />
                                            Date d'exigibilité
                                        </label>
                                        <input
                                            type="date"
                                            value={exigibilityDate}
                                            onChange={(e) => setExigibilityDate(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Type de créancier
                                        </label>
                                        <select
                                            value={creditorType}
                                            onChange={(e) => setCreditorType(e.target.value)}
                                            className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        >
                                            <option value="particulier">Particulier / Commerçant</option>
                                            <option value="professionnel">Professionnel (B2B)</option>
                                        </select>
                                    </div>

                                    <div className="flex items-center gap-4">
                                        <label className="flex items-center gap-2 cursor-pointer">
                                            <input
                                                type="checkbox"
                                                checked={capitalization}
                                                onChange={(e) => setCapitalization(e.target.checked)}
                                                className="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500"
                                            />
                                            <span className="text-sm font-medium text-gray-700">
                                                Capitalisation semestrielle
                                            </span>
                                        </label>
                                    </div>
                                </div>

                                <div className="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-6">
                                    <label className="flex items-center gap-2 cursor-pointer mb-3">
                                        <input
                                            type="checkbox"
                                            checked={isJudgment}
                                            onChange={(e) => setIsJudgment(e.target.checked)}
                                            className="w-5 h-5 text-amber-600 rounded focus:ring-2 focus:ring-amber-500"
                                        />
                                        <span className="text-sm font-medium text-gray-900">
                                            Condamnation judiciaire (majoration +5 points après 2 mois)
                                        </span>
                                    </label>
                                    
                                    {isJudgment && (
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Date de la condamnation
                                            </label>
                                            <input
                                                type="date"
                                                value={judgmentDate}
                                                onChange={(e) => setJudgmentDate(e.target.value)}
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500 focus:border-transparent"
                                            />
                                        </div>
                                    )}
                                </div>

                                <button
                                    onClick={handleCalculate}
                                    disabled={!debtAmount || !exigibilityDate}
                                    className="w-full bg-blue-600 text-white py-4 rounded-lg font-semibold hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                >
                                    <Calculator className="w-5 h-5" />
                                    Calculer les intérêts
                                </button>

                                {/* Résultats */}
                                {results && (
                                    <div className="mt-8 space-y-6 animate-slide-in">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                                <div className="text-sm text-gray-600 mb-1">Montant principal</div>
                                                <div className="text-2xl font-bold text-blue-600">{results.debtAmount.toFixed(2)} €</div>
                                            </div>
                                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                                <div className="text-sm text-gray-600 mb-1">Intérêts de retard</div>
                                                <div className="text-2xl font-bold text-green-600">{results.totalInterest.toFixed(2)} €</div>
                                            </div>
                                            <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                                <div className="text-sm text-gray-600 mb-1">Montant total dû</div>
                                                <div className="text-2xl font-bold text-purple-600">{results.totalAmount.toFixed(2)} €</div>
                                            </div>
                                        </div>

                                        <div className="bg-gray-50 rounded-lg p-4">
                                            <div className="text-sm text-gray-600">
                                                Période: {results.startDate} - {results.endDate} ({results.durationDays} jours)
                                            </div>
                                        </div>

                                        {/* Graphique */}
                                        <div className="bg-white rounded-lg p-6 border">
                                            <h3 className="text-lg font-semibold mb-4">Évolution de la dette</h3>
                                            <div style={{ height: '300px' }}>
                                                <canvas ref={chartRef}></canvas>
                                            </div>
                                        </div>

                                        {/* Détails */}
                                        <div className="bg-gray-50 rounded-lg p-6">
                                            <h3 className="text-lg font-semibold mb-4">Détail par période</h3>
                                            <div className="space-y-2 max-h-96 overflow-y-auto">
                                                {results.interestDetails.map((detail, index) => (
                                                    <div key={index} className="bg-white rounded-lg p-3 border">
                                                        <div className="flex justify-between items-center">
                                                            <div>
                                                                <div className="text-sm font-medium">{detail.period}</div>
                                                                <div className="text-xs text-gray-600">{detail.semester} - {detail.rate}% × {detail.days}j</div>
                                                            </div>
                                                            <div className="text-right">
                                                                <div className="font-semibold text-blue-600">{detail.interest.toFixed(2)} €</div>
                                                                {detail.isMajorated && (
                                                                    <div className="text-xs text-red-600 font-medium">+5pts majoration</div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <button
                                            onClick={generatePDF}
                                            className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors flex items-center justify-center gap-2"
                                        >
                                            <Download className="w-5 h-5" />
                                            Télécharger le rapport PDF
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Mode import Excel */}
                        {mode === 'excel' && (
                            <div className="space-y-6 animate-slide-in">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-2xl font-bold text-gray-900 mb-4">Import depuis Excel</h2>
                                    
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                                        <div className="flex items-start gap-3">
                                            <Info className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                                            <div className="text-sm text-blue-900">
                                                <p className="font-semibold mb-2">Comment utiliser l'import Excel :</p>
                                                <ol className="list-decimal list-inside space-y-1 ml-2">
                                                    <li>Sélectionnez vos lignes dans Excel (avec ou sans en-tête)</li>
                                                    <li>Copiez (Ctrl+C ou Cmd+C)</li>
                                                    <li>Collez dans la zone ci-dessous (Ctrl+V ou Cmd+V)</li>
                                                    <li>La détection est automatique !</li>
                                                </ol>
                                                <p className="mt-3 font-medium">Formats de montants acceptés :</p>
                                                <ul className="list-disc list-inside ml-2 mb-2">
                                                    <li><code className="bg-white px-1 rounded">15625</code> ou <code className="bg-white px-1 rounded">15625 €</code></li>
                                                    <li><code className="bg-white px-1 rounded">15 625</code> ou <code className="bg-white px-1 rounded">15 625 €</code> (avec espaces)</li>
                                                    <li><code className="bg-white px-1 rounded">15625.50</code> ou <code className="bg-white px-1 rounded">15625,50</code></li>
                                                    <li><code className="bg-white px-1 rounded">15 625,50€</code> (tous formats combinés)</li>
                                                </ul>
                                                <p className="font-medium">Formats de dates acceptés :</p>
                                                <ul className="list-disc list-inside ml-2">
                                                    <li><code className="bg-white px-1 rounded">31/12/2023</code> (format français - recommandé)</li>
                                                    <li><code className="bg-white px-1 rounded">31-12-2023</code> ou <code className="bg-white px-1 rounded">31.12.2023</code></li>
                                                    <li><code className="bg-white px-1 rounded">2023-12-31</code> (format ISO)</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="mb-6">
                                        <label className="block text-sm font-medium text-gray-700 mb-2">
                                            Collez vos données Excel ici
                                        </label>
                                        <textarea
                                            ref={textareaRef}
                                            value={excelData}
                                            onChange={(e) => setExcelData(e.target.value)}
                                            onPaste={handlePaste}
                                            placeholder="Collez directement depuis Excel. Exemples de formats acceptés :

31/12/2023	15625 €
31/12/2024	62500 €

ou

Facture 001    1500.50    15/01/2023
Facture 002    2 300,75€  20/03/2023"
                                            className="w-full h-48 px-4 py-3 border-2 border-dashed border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none font-mono text-sm"
                                        />
                                        {excelData && (
                                            <button
                                                onClick={() => {
                                                    const { debts, errors } = parseExcelData(excelData);
                                                    setParsedDebts(debts);
                                                    setParseErrors(errors);
                                                    setShowPreview(true);
                                                }}
                                                className="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-colors text-sm font-medium"
                                            >
                                                🔍 Analyser les données
                                            </button>
                                        )}
                                    </div>

                                    {/* Paramètres communs */}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                        <div>
                                            <label className="block text-sm font-medium text-gray-700 mb-2">
                                                Type de créancier
                                            </label>
                                            <select
                                                value={creditorType}
                                                onChange={(e) => setCreditorType(e.target.value)}
                                                className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                            >
                                                <option value="particulier">Particulier / Commerçant</option>
                                                <option value="professionnel">Professionnel (B2B)</option>
                                            </select>
                                        </div>

                                        <div className="flex items-center gap-4">
                                            <label className="flex items-center gap-2 cursor-pointer">
                                                <input
                                                    type="checkbox"
                                                    checked={capitalization}
                                                    onChange={(e) => setCapitalization(e.target.checked)}
                                                    className="w-5 h-5 text-blue-600 rounded"
                                                />
                                                <span className="text-sm font-medium text-gray-700">
                                                    Capitalisation semestrielle
                                                </span>
                                            </label>
                                        </div>
                                    </div>

                                    {/* Aperçu des données parsées */}
                                    {showPreview && (parsedDebts.length > 0 || parseErrors.length > 0) && (
                                        <div className="mb-6 space-y-4">
                                            {parsedDebts.length > 0 && (
                                                <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <CheckCircle className="w-5 h-5 text-green-600" />
                                                        <h3 className="font-semibold text-green-900">
                                                            {parsedDebts.length} dette(s) détectée(s)
                                                        </h3>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {parsedDebts.map((debt, index) => (
                                                            <div key={index} className="bg-white rounded-lg p-3 border border-green-200">
                                                                <div className="flex justify-between items-center">
                                                                    <div>
                                                                        <div className="font-medium text-gray-900">{debt.reference}</div>
                                                                        <div className="text-sm text-gray-600">Date: {new Date(debt.date).toLocaleDateString('fr-FR')}</div>
                                                                    </div>
                                                                    <div className="text-right">
                                                                        <div className="font-bold text-green-600">{debt.amount.toFixed(2)} €</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}

                                            {parseErrors.length > 0 && (
                                                <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                                                    <div className="flex items-center gap-2 mb-3">
                                                        <AlertCircle className="w-5 h-5 text-red-600" />
                                                        <h3 className="font-semibold text-red-900">
                                                            {parseErrors.length} erreur(s) détectée(s)
                                                        </h3>
                                                    </div>
                                                    <div className="space-y-1 text-sm text-red-700">
                                                        {parseErrors.map((error, index) => (
                                                            <div key={index}>• {error}</div>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}

                                    <button
                                        onClick={calculateAllDebts}
                                        disabled={parsedDebts.length === 0}
                                        className="w-full bg-green-600 text-white py-4 rounded-lg font-semibold hover:bg-green-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                                    >
                                        <Calculator className="w-5 h-5" />
                                        Calculer toutes les dettes ({parsedDebts.length})
                                    </button>
                                </div>

                                {/* Résultats multiples */}
                                {multiResults.length > 0 && (
                                    <div className="bg-white rounded-xl shadow-lg p-6 animate-slide-in">
                                        <div className="flex justify-between items-center mb-6">
                                            <h2 className="text-2xl font-bold text-gray-900">Résultats du calcul</h2>
                                            <button
                                                onClick={generatePDF}
                                                className="bg-green-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-green-700 transition-colors flex items-center gap-2"
                                            >
                                                <Download className="w-4 h-4" />
                                                Télécharger PDF
                                            </button>
                                        </div>

                                        {/* Récapitulatif global */}
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                            <div className="bg-blue-50 rounded-lg p-4 border border-blue-200">
                                                <div className="text-sm text-gray-600 mb-1">Capital total</div>
                                                <div className="text-2xl font-bold text-blue-600">
                                                    {multiResults.reduce((sum, r) => sum + r.calculation.debtAmount, 0).toFixed(2)} €
                                                </div>
                                            </div>
                                            <div className="bg-green-50 rounded-lg p-4 border border-green-200">
                                                <div className="text-sm text-gray-600 mb-1">Intérêts totaux</div>
                                                <div className="text-2xl font-bold text-green-600">
                                                    {multiResults.reduce((sum, r) => sum + r.calculation.totalInterest, 0).toFixed(2)} €
                                                </div>
                                            </div>
                                            <div className="bg-purple-50 rounded-lg p-4 border border-purple-200">
                                                <div className="text-sm text-gray-600 mb-1">Total général</div>
                                                <div className="text-2xl font-bold text-purple-600">
                                                    {multiResults.reduce((sum, r) => sum + r.calculation.totalAmount, 0).toFixed(2)} €
                                                </div>
                                            </div>
                                        </div>

                                        {/* Détail par dette */}
                                        <div className="space-y-4">
                                            {multiResults.map((item, index) => (
                                                <div key={index} className="bg-gray-50 rounded-lg p-4 border">
                                                    <div className="flex justify-between items-start mb-3">
                                                        <div>
                                                            <h3 className="font-semibold text-gray-900 text-lg">{item.reference}</h3>
                                                            <p className="text-sm text-gray-600">
                                                                Exigible le: {new Date(item.date).toLocaleDateString('fr-FR')}
                                                            </p>
                                                        </div>
                                                        <div className="text-right">
                                                            <div className="text-sm text-gray-600">Total dû</div>
                                                            <div className="text-xl font-bold text-purple-600">
                                                                {item.calculation.totalAmount.toFixed(2)} €
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-4 text-sm">
                                                        <div>
                                                            <span className="text-gray-600">Principal:</span>
                                                            <span className="ml-2 font-medium">{item.calculation.debtAmount.toFixed(2)} €</span>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Intérêts:</span>
                                                            <span className="ml-2 font-medium text-green-600">{item.calculation.totalInterest.toFixed(2)} €</span>
                                                        </div>
                                                        <div>
                                                            <span className="text-gray-600">Durée:</span>
                                                            <span className="ml-2 font-medium">{item.calculation.durationDays} jours</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Références légales */}
                        <div className="bg-amber-50 rounded-xl shadow-lg p-6 border border-amber-200 mt-6">
                            <h3 className="text-lg font-semibold text-gray-800 mb-4 flex items-center gap-2">
                                <Info className="w-5 h-5" />
                                Références légales
                            </h3>
                            <div className="space-y-3 text-sm text-gray-700">
                                <div>
                                    <p className="font-semibold text-gray-800">Base légale :</p>
                                    <ul className="list-disc list-inside space-y-1 ml-2">
                                        <li>Articles L. 313-2 et suivants du Code monétaire et financier</li>
                                        <li>Article L. 313-3 CMF - Majoration de 5 points en cas de condamnation</li>
                                        <li>Loi n° 75-619 du 11 juillet 1975, article 3</li>
                                        <li>Ordonnance n° 2014-947 du 20 août 2014</li>
                                        <li className="text-green-700 font-medium">🆕 Arrêté du 19 juin 2025 (taux S2 2025: 6.65% particuliers, 2.76% professionnels)</li>
                                    </ul>
                                </div>
                                <div>
                                    <p className="font-semibold text-gray-800">Formule de calcul :</p>
                                    <p className="italic bg-white p-2 rounded border">
                                        Intérêts = (Capital × Taux × Nombre de jours) ÷ (365 × 100)
                                    </p>
                                </div>
                                <div>
                                    <p className="font-semibold text-gray-800">Particularités :</p>
                                    <ul className="list-disc list-inside space-y-1 ml-2">
                                        <li>Capitalisation semestrielle des intérêts depuis 2015 (Art. L.313-2 CMF)</li>
                                        <li>Majoration automatique de 5 points 2 mois après condamnation (Art. L.313-3 CMF)</li>
                                        <li>Taux distincts depuis 2015 : particuliers/commerçants vs professionnels (B2B)</li>
                                        <li>Pas de prescription pour les intérêts (suivent le principal)</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<DebtInterestCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
